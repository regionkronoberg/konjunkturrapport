---
title: ""
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: readable
    css: custom_font.css
    includes:
      in_header: 
        - toc_expand.js.html
---
# Konjunkturrapport

<img src="region_kronoberg_logo.png" style="width:200px; margin-top: 20px;" />
<br>
<br>
**Uppdaterad 2025-07-25 <br>
Regional utveckling, Region Kronoberg**
<br>
<br>
Rapporten är under utveckling och är framtagen inom enheten Verksamhetsstöd, Regional utveckling, <br> 
Region Kronoberg. Syftet är att med hjälp av indikatorer ge en övergripande bild av konjunkturläget och näringslivets status i Kronobergs län. Rapporten uppdateras kvartalsvis i takt med att ny statistik publiceras.

Kontakta oss!
Frågor kring rapportens innehåll ställs till regutveckling.analys@kronoberg.se.

# Kort sammanfattning
Kronoberg påverkas fortfarande av en utdragen lågkonjunktur med ett dämpat stämningsläge både bland hushåll och företag. Arbetslösheten är hög och långtidsarbetslösheten ökar, vilket visar på utmaningar att få fler i arbete. Samtidigt finns ett stort antal lediga jobb, vilket tyder på svårigheter att matcha rätt kompetens med arbetsmarknadens behov.

Näringslivet i länet uppvisar viss stabilitet med relativt få varsel. Nyföretagandet har ökat något jämfört med inledningen av 2024, men ligger fortsatt på en låg nivå sett till de senaste åren.

```{r paket setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Ladda paket 
library(tidyverse)
library(readxl)
library(openxlsx)
library(magrittr)
library(reshape2)
library(formattable)
library(kableExtra)
library(ggrepel)
library(sparkline)
library(writexl)
library(magick)
library(grid)
library(plotly)
library(rmarkdown)
library(httr)
library(jsonlite)
library(glue)
library(lubridate)
library(dplyr)
library(rsconnect)
```

```{r API_BNP, echo=FALSE}

# API-endpoint
url <- "https://prognos.konj.se:443/PxWeb/api/v1/sv/SenastePrognosen/f09_bnpkonsumtioninvesteringarochutrikeshandel/F0901.px"

# JSON-fråga (ändrad till json-svar istället för px, (kräver ingen nedsparad px-fil))
body <- list(
  query = list(
    list(
      code = "variabel",
      selection = list(
        filter = "item",
        values = list("F0901Nbnpmp")
      )
    ),
    list(
      code = "enhet",
      selection = list(
        filter = "item",
        values = list("FPC")
      )
    ),
    list(
      code = "period",
      selection = list(
        filter = "item",
        values = as.character(2020:2030)
      )
    )
  ),
  response = list(format = "json")
)

# Skicka POST-förfrågan
res <- POST(url, body = body, encode = "json")


# Kontrollera för fel
stop_for_status(res)

# Läs och konvertera svaret till R-objekt
json_raw <- content(res, as = "text", encoding = "UTF-8")
json_data <- fromJSON(json_raw)

bnpdata <- as.data.frame(json_data$data)

# Lägg till period-etiketter
bnpdata$år <- sapply(bnpdata$key, function(x) x[3])  # Tredje nyckeln är år
bnpdata$värde <- as.numeric(bnpdata$values)

# Marlera om det är utfall eller prognos
bnpdata <- bnpdata %>%
  mutate(
    typ = ifelse(as.numeric(år) <= 2024, "Utfall", "Prognos")
  )
```

```{r datahämtning_bnp, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Hämta BNP för 2024 och 2025
bnp_2024 <- bnpdata %>% filter(år == "2024") %>% pull(värde)
bnp_2025 <- bnpdata %>% filter(år == "2025") %>% pull(värde)
```

# Konjunktur

Sverige befinner sig i en lågkonjunktur. Konjunkturinstitutet bedömmer att den blir mer långdragen än vad som tidigare förväntades. Återhämtningen som påbörjades under 2024 har tappat fart och en vändningen väntas först en bit in i 2025. Detta medför att lågkonjunkturen lär kvarstå även under 2026.

Den globala efterfrågan påverkas negativt av ökad osäkerhet och geopolitiska spänningar. Den främsta förklaringen till den uteblivna återhämtningen bedöms dock vara det fortsatt låga konsumentförtroendet och återhållsamma hushåll.

Även om reallönerna nu ökar, inflationen sjunker jämfört med 2023 och 2024 och räntekostnaderna minskar, har hushållen varit återhållsamma. I utgångsläget har hushållen dock ett högt sparande och med snabbt stigande reallöner i år väntas hushållens konsumtion vara den huvudsakliga driftkraften i återhämtningen. Även om konjunkturvändningen förväntas under 2025 har Konjunkturinstitutet i sin senaste prognos reviderat ned BNP-tillväxten för 2025 till `r round(bnp_2025, 1)` procent. För jämförelse ökade BNP med `r round(bnp_2024, 1)` procent under 2024.

```{r diagram_bnp, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Skapa stapeldiagram med annan färg för prognos
ggplot(bnpdata, aes(x = as.factor(år), y = värde)) +
  # Utfall utan förklaring
  geom_bar(data = subset(bnpdata, typ == "Utfall"),
           aes(fill = typ), stat = "identity", show.legend = FALSE) +

  # Prognos med förklaring
  geom_bar(data = subset(bnpdata, typ == "Prognos"),
           aes(fill = typ), stat = "identity") +

  # Etiketter på staplarna
  geom_text(aes(label = paste0(värde, "%"),
                vjust = ifelse(värde < 0, 1.5, -0.5)), size = 3.5) +

  # Nollinje
  geom_hline(yintercept = 0, color = "black", linewidth = 0.8) +

  # Färger – men bara "Prognos" får förklaring
  scale_fill_manual(
    values = c("Utfall" = "#E13288", "Prognos" = "grey60"),
    breaks = "Prognos",     # Visa endast "Prognos" i legend
    labels = "Prognos",     # Valfri visningstext
    name = ""               # Ingen rubrik i förklaringen
  ) +

  scale_y_continuous(limits = c(-2.5, NA)) +
  # Övriga rubriker
  labs(
    title = "Sveriges BNP i fasta priser (förändring i procent)",
    x = "",
    y = "Förändring (%)",
    caption = "Källa: Konjunkturinstitutet och bearbetningar av Region Kronoberg."
  ) +

  theme_minimal()
```

```{r hämtning_bardata, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Läs in data
bardata <- read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\barindikator.xlsx")
# Konvertera Datum till Date (från POSIXct)
bardata$Datum <- as.Date(bardata$Datum)

# Gör datan lång
bardata_long <- bardata %>%
  pivot_longer(
    cols = c(`Barometerindikatorn`, `Totala näringslivet`, `Konfidensindikator hushåll`),
    names_to = "Serie",
    values_to = "Värde"
  )

# Visa bara senaste 5 åren
bardata_long <- bardata_long %>% filter(Datum >= as.Date("2020-01-01"))

# Extrahera månad, värde
bardata_long <- bardata_long %>%
  filter(Serie == "Barometerindikatorn") %>%
    arrange(Datum) %>%
  mutate(
    Månad = format(Datum, "%Y-%m")  # valfri extrakolumn
  )

# Hämta senaste och föregående månad
senaste_månad_bardata <- tail(bardata_long, 1)
föregående_månad_bardata <- tail(bardata_long, 2)[1, ]
```

```{r förberedelser_bartext, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
tolka_stämning <- function(värde) {
  case_when(
    värde > 110 ~ "högkonjunktur",
    värde > 100 & värde <= 110 ~ "starkt stämningsläge",
    värde > 90 & värde < 100 ~ "dämpat stämningsläge",
    värde == 100 ~ "i nivå med historiskt genomsnitt",
    värde < 90 ~ "lågkonjunktur",
    TRUE ~ "okänt läge"
  )
}
```

```{r bartext, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
ändring <- round(senaste_månad_bardata$Värde - föregående_månad_bardata$Värde, 1)
tolkning <- tolka_stämning(senaste_månad_bardata$Värde)

text <- glue(
  "Barometerindikatorn ger en samlad bild av det svenska konjunkturläget genom att väga samman stämningsläget i näringslivet och bland hushållen. ",
  "Ett värde på 100 motsvarar det historiska genomsnittet (normalläge), medan värden över 110 signalerar högkonjunktur och värden under 90 lågkonjunktur.\n\n",
  "I {format(senaste_månad_bardata$Datum, '%B %Y')} uppgick indikatorvärdet till {round(senaste_månad_bardata$Värde, 1)}, vilket är förenligt med {tolkning}. ",
  if (ändring > 0) {
    glue("Detta var en ökning med {ändring} enheter jämfört med föregående månad. ")
  } else if (ändring < 0) {
    glue("Detta var en minskning med {abs(ändring)} enheter jämfört med föregående månad. ")
  } else {
    "Värdet var oförändrat jämfört med föregående månad. "
  } ,
  "Även om stämningsläget förbättrades något bland hushållen jämfört med föregående månad är stämningsläget fortsatt mycket lågt och tynger ner barometerindikatorn. Ser vi till stämningsläget i näringslivet var det i linje med det historiska genomsnittet.\n\n",
  "Från och med maj 2025 ställs tillfälliga frågor till företag inom tillverkningssektorn för att undersöka effekterna av förändrade tullsatser. Hittills uppger 20 procent av företagen att deras produktionsvolym har minskat något till följd av de förändrade tullarna. ",
  "En av frågorna rör framtidsutsikterna, där drygt 40 procent av företagen anger att de förväntar sig en minskning i produktionsvolymen framöver. Minskningen bedöms dock som begränsad, då mycket få företag uppger att produktionsvolymen har påverkats – eller förväntas påverkas – i stor utsträckning. Investeringarna har hittills inte påverkats nämnvärt av tullförändringarna.\n\n",
  "Konfidensindikatorn för handeln uppvisar ett starkt stämningsläge. Indikatorerna för bygg och tillverkning ligger i paritet med det historiska genomsnittet samtidigt som tjänstesektorn visar på ett dämpat stämningsläge."
)
cat(text)
```

```{r graf_bardata, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
bardata_plot <- bardata %>%
  pivot_longer(
    cols = c(`Barometerindikatorn`, `Totala näringslivet`, `Konfidensindikator hushåll`),
    names_to = "Serie",
    values_to = "Värde"
  ) %>%
  filter(Datum >= as.Date("2020-01-01")) %>%
  mutate(
    tooltip = paste0(format(Datum, "%B %Y"), "<br>", round(Värde, 1))
  )

# Skapa ggplot med interaktiv text
p <- ggplot(bardata_plot, aes(x = Datum, y = Värde, text = tooltip)) +
  geom_line(aes(group = Serie), color = "#006633", size = 1) +
  geom_point(aes(text = tooltip), color = "#006633", size = 0.5, alpha = 0.6) +  # <-- tooltip-punkter
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +
  facet_wrap(~ Serie, nrow = 1) + # scales = "fixed" är default -> gemensam y-axel
  scale_x_date(
  breaks = seq(from = as.Date(format(min(bardata_plot$Datum), "%Y-01-01")),
               to = max(bardata_plot$Datum), 
               by = "1 year"),
  date_labels = "%b %Y"
) +
scale_y_continuous(limits = c(55, 145)) +
  labs(
    title = "Sveriges konjunkturbarometer",
    x = NULL,
    y = "Index"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    panel.grid = element_blank() # <-- Tar bort rutnätet
  )

# Gör plot interaktiv
ggplotly(p, tooltip = "text") %>%
    layout(
    annotations = list(
      list(
        text = "Källa: Konjunkturinstitutet och bearbetningar av Region Kronoberg.",
        x = 1, y = -0.2,  # Höger och nedanför x-axeln
        xref = "paper", yref = "paper",
        xanchor = "right", yanchor = "top", # Fäster i hörnet
        showarrow = FALSE,
        font = list(size = 11, color = "black")
      )
    ),
    margin = list(b = 100) # Lägg till utrymme under grafen
  )
```

# Arbetsmarknad

## Arbetslöshet

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Läs data
arblosdata <- read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\arblos.xlsx", 
                        sheet = "Blad1")
arblosdata$Datum <- as.Date(arblosdata$Datum)
arblosdata$Arbetslöshet <- round(arblosdata$Arbetslöshet * 100, 1)

# Hämta nyckelvärden
senaste_arblos <- arblosdata %>% filter(Datum == max(Datum), Region == "Kronobergs län") %>%
  slice(1) # Säkrar exakt en rad
föregående_månad_arblos <- arblosdata %>% filter(Datum == max(Datum) %m-% months(1), Region == "Kronobergs län") %>%
  slice(1)
föregående_år_arblos <- arblosdata %>% filter(Datum == max(Datum) %m-% years(1), Region == "Kronobergs län") %>%
  slice(1)
sex_manader_sen <- arblosdata %>% filter(Datum == max(Datum) %m-% months(6), Region == "Kronobergs län") %>%
  slice(1)

# Skillnader
diff_manad_arblos <- senaste_arblos$Arbetslöshet - föregående_månad_arblos$Arbetslöshet
diff_ar_arblos <- senaste_arblos$Arbetslöshet - föregående_år_arblos$Arbetslöshet
diff_6m_arblos <- senaste_arblos$Arbetslöshet - sex_manader_sen$Arbetslöshet

# Trender
trend_manad_arblos <- ifelse(diff_manad_arblos > 0, "ökning", ifelse(diff_manad_arblos < 0, "minskning", "oförändrat"))
trend_ar_arblos <- ifelse(diff_ar_arblos > 0, "ökning", ifelse(diff_ar_arblos < 0, "minskning", "oförändrat"))
trend_6m_arblos <- ifelse(diff_6m_arblos > 0, "ökning", ifelse(diff_6m_arblos < 0, "minskning", "oförändrat"))

# Medelnivå
medel_arblos <- mean(arblosdata$Arbetslöshet, na.rm = TRUE)
nivå <- dplyr::case_when(
  senaste_arblos$Arbetslöshet >= medel_arblos + 0.5 ~ "hög",
  senaste_arblos$Arbetslöshet <= medel_arblos - 0.5 ~ "låg",
  TRUE ~ "normal"
)

# Text
text_arblos <- glue(
  "Arbetslösheten i Kronoberg uppgick till **{senaste_arblos$Arbetslöshet}%** i {format(senaste_arblos$Datum, '%B %Y')}. ",
  "Jämfört med samma månad ifjol är det en {trend_ar_arblos} med {abs(round(diff_ar_arblos, 1))} procentenheter. ",
  "Under de senaste sex månaderna visar trenden en **{trend_6m_arblos}** med {abs(round(diff_6m_arblos, 1))} procentenheter. ",
  "Den aktuella arbetslösheten är **{nivå}** i förhållande till det historiska snittet sedan januari 2022."
)

cat(text_arblos, "\n")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Lägg till en ny kolumn i data med formaterad text för tooltip
arblosdata$tooltip_text <- paste0(
  format(arblosdata$Datum, "%Y-%m"),
  "<br>Arbetslöshet: ",
  sprintf("%.1f%%", arblosdata$Arbetslöshet),
  "<br>Region: ",
  arblosdata$Region
)

#Skapa ett linjediagram
p <- ggplot(arblosdata, aes(x = Datum, y = Arbetslöshet, color = Region)) +
  geom_line(linewidth = 1.5) +
  geom_point(aes(text = tooltip_text), size = 0.1) +
  labs(
    title = "Arbetslöshet (%)",
    subtitle="",
    caption= "Källa: Arbetsförmedlingen.",
    x="",
    y="",
   ) +
    theme_minimal() + 
    theme(legend.position= "right") +
    scale_x_date(
      breaks = seq(as.Date("2022-01-01"), as.Date("2025-03-01"), by = "6 months"),
      date_labels = "%b %Y"
  ) +
  ylim(6, 8) +
  scale_color_manual(values = c("Kronobergs län" = "#006633", "Riket" = "#E13288"))+
  guides(color=guide_legend(title = NULL))

ggplotly(p, tooltip = "text") %>%
    layout(
    annotations = list(
      list(
        text = "Källa: Arbetsförmedlingen och bearbetningar av Region Kronoberg.",
        x = 1, y = -0.2,  # Höger och nedanför x-axeln
        xref = "paper", yref = "paper",
        xanchor = "right", yanchor = "top", # Fäster i hörnet
        showarrow = FALSE,
        font = list(size = 11, color = "black")
      )
    ),
    margin = list(b = 100) # Lägg till utrymme under grafen
  )
```

## Långtidsarbetslöshet

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Läs in data
langtidsdata <-read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\langtidsarblos.xlsx", 
                   sheet = "Blad1")

# Förbered data
langtidsdata <- langtidsdata %>%
  mutate(
    Andel_långtidsarbetslösa = round(Långtidsarbetslösa_andel * 100, 0),
    Datum = as.Date(Datum)
  ) %>%
  rename(
    Antal_långtidsarbetslösa = Långtidsarbetslösa_antal
  )
    
# Hitta senaste månad
senaste_langtid <- max(langtidsdata$Datum, na.rm = TRUE)

# Filtrera senaste månaden
senaste_langtidsdata <- langtidsdata %>%
  filter(Datum == senaste_langtid)

# Datum sex månader tidigare
datum_6mån <- senaste_langtid %m-% months(6)

# Data för nu och sex månader tillbaka
langtidsdata_6mån <- langtidsdata %>%
  filter(Datum %in% c(datum_6mån, senaste_langtid)) %>%
  arrange(Datum)

# Trender
antal_diff <- diff(langtidsdata_6mån$Antal_långtidsarbetslösa)
langtids_trend <- case_when(
  antal_diff > 0 ~ "stigande",
  antal_diff < 0 ~ "sjunkande",
  TRUE ~ "oförändrat"
)

# Jämförelse med covid-åren
snitt_covid <- langtidsdata %>%
  filter(year(Datum) %in% 2020:2021) %>%
  summarise(snitt = mean(Antal_långtidsarbetslösa, na.rm = TRUE)) %>%
  pull(snitt)

langtids_niva_covid <- case_when(
  senaste_langtidsdata$Antal_långtidsarbetslösa > snitt_covid * 1.2 ~ "mycket högre",
  senaste_langtidsdata$Antal_långtidsarbetslösa > snitt_covid ~ "något högre",
  senaste_langtidsdata$Antal_långtidsarbetslösa < snitt_covid * 0.8 ~ "mycket lägre",
  senaste_langtidsdata$Antal_långtidsarbetslösa < snitt_covid ~ "något lägre",
  TRUE ~ "ungefär lika"
)

# Generera interaktiv text
glue("
I {format(senaste_langtid, '%B %Y')} var **{senaste_langtidsdata$Antal_långtidsarbetslösa} personer** långtidsarbetslösa, 
vilket motsvarar {senaste_langtidsdata$Andel_långtidsarbetslösa} procent av det totala antalet arbetslösa i Kronoberg. 
Med långtidsarbetslösa avses personer som har varit arbetslösa mer än sex månader. 
De senaste sex månaderna är antalet långtidsarbetslösa **{langtids_trend}**. 
Sedan kulmen av Covid-19-pandemin och åren 2020–2021 har antalet långtidsarbetslösa varit **{langtids_niva_covid}**.
")

# I mars 2025 var 4 882 personer långtidsarbetslösa, vilket motsvarar 65 procent av det totala antalet arbetslösa i Kronoberg. Med långtidsarbetslösa avses personer som har varit arbetslösa mer än sex månader. De senaste sex månaderna är antalet långtidsarbetslösa stigande/sjunkande trenden/ofärändrat. Sedan kulmen av Covid-19-pandemin och åren 2020-2021 har antalet långtidsarbetslösa varit något/mycket lägre/högre.
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
jan_breaks <- seq(
  from = as.Date("2019-01-01"),  # Justera startdatum efter behov
  to = as.Date("2025-01-01"),    # Justera slutdatum efter ditt data
  by = "1 year"
)

#Skapa ett linjediagram
ggplot(langtidsdata, aes(x = Datum))+
  geom_line(aes(y = Antal_långtidsarbetslösa, color = "Antal_långtidsarbetslösa"), size=1.5)+  # Första linjen
  geom_line(aes(y = Andel_långtidsarbetslösa * 100, color = "Andel_långtidsarbetslösa"), size=1.5)+  # Andra linjen, skalad för att passa på samma graf
  scale_y_continuous(name = "Antal långtidsarbetslösa",
    sec.axis = sec_axis(~ . / 100, name = "Andel långtidsarbetslösa (%)")  # Sekundär axel
  ) + labs(x = "", color = "Variabel") + theme_minimal()+
  scale_x_date(breaks = jan_breaks,
               date_labels = "%b %Y") + 
  scale_color_manual(values = c("Antal_långtidsarbetslösa" = "#006633", "Andel_långtidsarbetslösa" = "#E13288")) +
    labs(
    x = "",
    color = "Variabel",
    caption = "Källa: Arbetsförmedlingen och bearbetningar av Region Kronoberg"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(size = 9, hjust = 0, margin = margin(t = 10))# Vänsterjusterad caption
  )
```

## Vakanser

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Lediga jobb
vakansdata <- read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\vakanser.xlsx", 
                         sheet = "Blad1") %>%
  mutate(Datum = as.Date(Datum)) %>%
  rename(
    ej_sommarjobb = `Ej sommarjobb`,
    sommarjobb = Sommarjobb,
    alla_lediga_jobb = `Alla lediga jobb`
  )

# Hämta senaste, föregående månad och föregående år
senaste_vak <- vakansdata %>% filter(Datum == max(Datum))
föregående_månad_vak <- vakansdata %>% filter(Datum == max(Datum) %m-% months(1))
föregående_år_vak <- vakansdata %>% filter(Datum == max(Datum) %m-% years(1))

# Skillnader
diff_manad_vak <- senaste_vak$alla_lediga_jobb - föregående_månad_vak$alla_lediga_jobb
diff_ar_vak <- senaste_vak$alla_lediga_jobb - föregående_år_vak$alla_lediga_jobb

# Formulera text
trend_manad_vak <- ifelse(diff_manad_vak > 0, "ökning", "minskning")
trend_ar_vak <- ifelse(diff_ar_vak > 0, "ökning", "minskning")
```

Det totala antalet lediga jobb<sup>1</sup> på arbetsmarknaden i Kronobergs län uppgick till **`r senaste_vak$alla_lediga_jobb` stycken** i `r format(senaste_vak$Datum, '%B %Y')`. Det är en **`r trend_ar_vak`** i jämförelse med samma månad föregående år, dock en `r trend_manad_vak` med `r abs(diff_manad_vak)` lediga jobb jämfört med föregående månad. 

Statistiken speglar efterfrågan på arbetskraft i Kronobergs län och kan ge en indikation på konjunkturutvecklingen i länet. En ökning av antalet lediga jobb tyder ofta på en starkare konjunktur och ett ökat behov av arbetskraft. Motsatt gäller att en minskning av antalet lediga jobb signalerar att arbetsmarknaden bromsar in. 

En fortsatt hög arbetslöshet i kombination med många lediga jobb kan även tyda på en matchningsproblematik - dvs. att arbetsgivarna har svårt att hitta kompetens som motsvarar kraven i de lediga tjänsterna, trots att det finns arbetssökande. 

Diagrammet visar antalet lediga jobb över tid, med en uppdelning mellan sommarjobb och andra lediga jobb mellan år 2020 - 2025. Trenden har en tydlig säsongsvariation där antalet lediga jobb ökar markant under våren och sommaren, för att sedan sjunka under hösten. Sommarjobben bidrar till topparna under perioden. Åren 2020–2021 påverkades mycket av pandemin med färre lediga jobb, medan vi ser en återhämtning och stark ökning från och med 2022. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(vakansdata, aes(x = Datum)) +
  geom_area(aes(y = sommarjobb, fill = "Sommarjobb")) +
  geom_ribbon(aes(ymin = sommarjobb, ymax = sommarjobb + ej_sommarjobb, fill = "Ej sommarjobb")) +
  geom_line(aes(y = alla_lediga_jobb, color = "Alla lediga jobb"), size = 1.2) +
  scale_fill_manual(
    values = c("Sommarjobb" = "#006633", "Ej sommarjobb" = "#E13288"),
    name = ""
  ) +
  scale_color_manual(
    values = c("Alla lediga jobb" = "black"),
    name = ""
  ) +
  labs(
    title = "Antal lediga jobb över tid",
    x = "", y = "",
    fill = "Jobbtyp",
    caption= "Källa: Arbetsförmedlingen och bearbetningar av Region Kronoberg.",
  ) +
  theme_minimal()
```

## Varsel

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Varsel

# Läs in och förbered data ---
varseldata <- read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\varsel.xlsx") %>%
  mutate(Datum = as.Date(Datum)) %>%              # Säkerställ att Datum är i Date-format
  rename(`Antal varslade` = Antal_varsel)         # Byt namn på kolumn för tydlighet

# Dynamisk text för Kronoberg:

# 1 Månadssammanställning för Kronoberg
varsel_kronoberg <- varseldata %>%
  filter(Region == "Kronobergs län") %>%
  mutate(Månad = floor_date(Datum, "month")) %>%
  group_by(Månad) %>%
  summarise(`Antal varslade` = sum(`Antal varslade`, na.rm = TRUE)) %>%
  ungroup()

# 2 Årssammanställning för Kronoberg
varsel_kronoberg_år <- varseldata %>%
  filter(Region == "Kronobergs län") %>%
  mutate(År = year(Datum)) %>%
  group_by(År) %>%
  summarise(`Antal varslade` = sum(`Antal varslade`, na.rm = TRUE)) %>%
  ungroup()

# 3 Hämta senaste månad
senaste_datum <- max(varsel_kronoberg$Månad) # Tar fram det senaste månadsvärdet i kolumnen månad
senaste2 <- varsel_kronoberg %>% filter(Månad == senaste_datum) # Filtrerar och hämtar rad som har månad = senaste
föregående_månad <- varsel_kronoberg %>% filter(Månad == (senaste_datum %m-% months(1))) # Hämtar föregående månad

# 4 Värde föregående månad (hantera om det saknas)
föregående_månad_val <- ifelse(nrow(föregående_månad) > 0, föregående_månad$`Antal varslade`, NA)

# 5 Skillnad och trend månadsdata
diff_manad2 <- senaste2$`Antal varslade` - föregående_månad_val
trend_månad <- ifelse(is.na(diff_manad2), "saknas jämförelsedata", ifelse(diff_manad2 > 0, "ökning", "minskning"))

# 6 Hämta de tre senaste åren för jämförelse
år_vanligast <- sort(unique(varsel_kronoberg_år$År), decreasing = TRUE)
nyast_år <- år_vanligast[1]       # Nyast år i data, t.ex. 2025

föregående_1 <- nyast_år - 1       # Föregående år, t.ex. 2024
föregående_2 <- nyast_år - 2       # Föregående minus 2 år, t.ex. 2023

# 7 Hämta värden för 2024 och 2023 (eller andra år enligt ovan)
antal_föregående_1 <- varsel_kronoberg_år %>% filter(År == föregående_1) %>% pull(`Antal varslade`)
antal_föregående_2 <- varsel_kronoberg_år %>% filter(År == föregående_2) %>% pull(`Antal varslade`)

# 8 Dynamiskt jämförelseord för år
jämförelseord_år <- ifelse(is.na(antal_föregående_1) | is.na(antal_föregående_2), "saknas jämförelsedata",
                      ifelse(antal_föregående_1 > antal_föregående_2, "fler än",
                      ifelse(antal_föregående_1 < antal_föregående_2, "färre än",
                             "lika många som")))

# Dynamisk text för grannlän:

# 1 Definiera viktiga variabler och län
grannlan <- c("Jönköpings län", "Skåne län", "Kalmar län", "Blekinge län", "Hallands län")
kronoberg <- "Kronobergs län"

# 2 Hämta senaste månad i data 
senaste_månad <- max(floor_date(varseldata$Datum, "month"))

# 3 Funktion för att hämta antal varslade per län och månad
antal_varslade_per_lan <- function(lan, datum) {
  varseldata %>%
    filter(Region == lan, floor_date(Datum, "month") == datum) %>%
    summarise(sum_varslade = sum(`Antal varslade`, na.rm = TRUE)) %>%
    pull(sum_varslade) %>%
    replace_na(0)  # Om ingen data, returnera 0
}

# 4 Beräkna trender (ökning, minskning, oförändrat) mellan senaste månad och föregående månad för grannlän
trender <- sapply(grannlan, function(lan) {
  senaste <- antal_varslade_per_lan(lan, senaste_månad)
  föregående <- antal_varslade_per_lan(lan, senaste_månad %m-% months(1))
  if (senaste > föregående) {
    "ökning"
  } else if (senaste < föregående) {
    "minskning"
  } else {
    "oförändrat"
  }
})

# 5 Dela in län i grupper efter trend
grannlan_ökning <- names(trender)[trender == "ökning"]
grannlan_minskning <- names(trender)[trender == "minskning"]

# 6 Hämta varseldata per region och månad för data sedan januari 2022 ---
data_sedan_2022 <- varseldata %>%
  filter(Datum >= as.Date("2022-01-01")) %>%
  mutate(Månad = floor_date(Datum, "month")) %>%
  group_by(Region, Månad) %>%
  summarise(antal_varslade = sum(`Antal varslade`, na.rm = TRUE), .groups = "drop")

# 7 Beräkna maxvärde per region sedan 2022
max_per_region <- data_sedan_2022 %>%
  group_by(Region) %>%
  summarise(max_varsel = max(antal_varslade, na.rm = TRUE), .groups = "drop")

# 8 Hämta senaste månadens varsel per region 
senaste_varsel_per_region <- data_sedan_2022 %>%
  filter(Månad == senaste_månad) %>%
  select(Region, senaste_varsel = antal_varslade)

# 9 Slå ihop max och senaste månadens data och identifiera regioner med maxvärde i senaste månaden 
jämförelse <- senaste_varsel_per_region %>%
  left_join(max_per_region, by = "Region") %>%
  mutate(har_max_senaste = senaste_varsel == max_varsel)

regioner_med_max_senaste <- jämförelse %>%
  filter(har_max_senaste) %>%
  pull(Region)

# 10 Hjälpfunktion för snygg textlista av län utan " län" suffix
format_lan <- function(lan_vec) { # Funktionen tar en vektor med länsnamn, t.ex. c("Skåne län).
  lan_vec <- gsub(" län", "", lan_vec)  # Ersätter län med tom sträng.
  if (length(lan_vec) == 1) { # Om vektorn innehåller bara ett län
    lan_vec
  } else if (length(lan_vec) == 2) { # Om vektorn innehåller exakt två län, används " och " som separator.
    paste(lan_vec, collapse = " och ")
  } else {
    paste0(paste(lan_vec[-length(lan_vec)], # tar alla län utom det sista
                 collapse = ", "), " och ", lan_vec[length(lan_vec)]) #  sätter komma mellan dem, lägger till och före sista länet.
  }
}

# 11 Bygg textdelar för ökning och minskning 
text_ökning <- if(length(grannlan_ökning) > 0) {
  paste0("ökade antalet varslade personer i de sydsvenska grannlänen ", format_lan(grannlan_ökning), ". ")
} else {
  ""
}

text_minskning <- if(length(grannlan_minskning) > 0) {
  paste0("I länen ", format_lan(grannlan_minskning), " minskade antalet varslade personer i jämförelse med föregående månad. ")
} else {
  ""
}

# 12 Beräkna Kronobergs och grannlänens totala varsel under senaste kvartalet (3 senaste månader) 
kvartal_månader <- seq.Date(from = senaste_månad %m-% months(2), to = senaste_månad, by = "month")

kvartal_data <- varseldata %>%
  mutate(Månad = floor_date(Datum, "month")) %>%
  filter(Månad %in% kvartal_månader) %>%
  group_by(Region) %>%
  summarise(antal_varslade_kvartal = sum(`Antal varslade`, na.rm = TRUE), .groups = "drop")

kronoberg_kvartal <- kvartal_data %>% filter(Region == kronoberg) %>% pull(antal_varslade_kvartal)
grannlan_kvartal <- kvartal_data %>% filter(Region %in% grannlan) %>% pull(antal_varslade_kvartal)

# 13 Beräkna medelvärde för grannlän under kvartalet
medel_grannlan <- mean(grannlan_kvartal, na.rm = TRUE)

# 14 Definiera tolerans (±10%) för att bedöma om Kronoberg är relativt låg/hög 
tolerans <- 0.1 * medel_grannlan

# 15 Jämför Kronobergs kvartalsvärde med grannlänens och skapa jämförelsetext
kronoberg_jämförelse <- if (is.na(kronoberg_kvartal) || is.na(medel_grannlan)) {
  "saknas jämförelsedata"
} else if (kronoberg_kvartal < (medel_grannlan - tolerans)) {
  "på en relativt låg nivå"
} else if (kronoberg_kvartal > (medel_grannlan + tolerans)) {
  "på en relativt hög nivå"
} else {
  "på ungefär samma nivå"
}

# Skapa dynamisk text
text_varsel <- glue(
  "I {format(senaste_datum, '%B %Y')} varslades **{senaste2$`Antal varslade`} personer** i Kronobergs län, vilket var en **{trend_månad}** jämfört med föregående månad.<br>",
  "Under helåret {föregående_1} varslades totalt {antal_föregående_1} personer i Kronobergs län, vilket är {jämförelseord_år} de {antal_föregående_2} som varslades under {föregående_2}."
)

full_text <- glue(
  "Under {format(senaste_månad, '%B %Y')} ",
  "{text_ökning}",
  if(length(regioner_med_max_senaste) > 0) 
    paste0("Särskilt stor var ökningen i ", format_lan(regioner_med_max_senaste), 
           " som såg det största antalet varslade personer sedan januari 2022. ") 
  else "", 
  "{text_minskning}",
  "Antalet varslade personer i Kronoberg har legat **{kronoberg_jämförelse}** under första kvartalet {year(senaste_månad)} i jämförelse med grannlänen."
)

# Skriv ut sluttext
cat(text_varsel, "<br><br>", full_text)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Skapa tooltip för hela datamängden
varseldata$tooltip_text <- paste0(
  format(varseldata$Datum, "%Y-%m"),
  "<br>Antal varslade: ",
  format(varseldata$`Antal varslade`, big.mark = " "),
  "<br>Region: ",
  varseldata$Region
)

# Hitta första dagen i senaste månad
senaste_manad <- floor_date(max(varseldata$Datum), unit = "month")

# Skapa vektor av alla motsvarande månader bakåt i tiden (exkl. senaste månad)
historiska_manader <- seq(from = senaste_manad %m-% years(1),
                          to = senaste_manad %m-% years(10),
                          by = "-1 year")

# Filtrera historiska rader
historiskadata <- varseldata %>%
  filter(floor_date(Datum, unit = "month") %in% historiska_manader)

# Filtrera senaste månadens data
senastedata <- varseldata %>%
  filter(format(Datum, "%Y-%m") == format(senaste_manad, "%Y-%m"))

# Skapa ggplot
p2 <- ggplot(varseldata, aes(x = Datum, y = `Antal varslade`, color = Region)) +
  
  # Linjer för tidsserien
  geom_line(aes(text = tooltip_text, group = Region), alpha = 0.7, linewidth = 0.7) +
  
  # Svart punkt för senaste månad
  geom_point(
    data = senastedata,
    aes(x = Datum, y = `Antal varslade`, text = tooltip_text),
    color = "black", size = 1.5, inherit.aes = FALSE
  ) +
  
  # Svarta punkter för samma månad varje tidigare år
  geom_point(
    data = historiskadata,
    aes(x = Datum, y = `Antal varslade`, text = tooltip_text),
    color = "black", size = 1.5, inherit.aes = FALSE
  ) +
  
  facet_wrap(~ Region, scales = "free_y") +
  
  labs(
    title = "Antal personer berörda av varsel om uppsägning",
    subtitle = paste("Senaste månad:", format(senaste_manad, "%B %Y")),
    caption = "Källa: Arbetsförmedlingen.",
    x = "",
    y = "Varierande skalor!"
  ) +
  
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(size = 10)
  ) +
  
  # Dynamisk x-axel: startar från 2022-01-01 till senaste månad
  scale_x_date(
    breaks = seq(as.Date("2022-01-01"), senaste_manad, by = "6 months"),
    date_labels = "%b %Y",
    limits = c(as.Date("2022-01-01"), senaste_manad)
  ) +
  
  scale_color_manual(values = c(
    "Kronobergs län"     = "#4CAF50",
    "Blekinge län"       = "#1A237E",
    "Hallands län"       = "#4FC3F7",
    "Kalmar län"         = "#EF5350",
    "Jönköpings län"     = "#AD1457",
    "Skåne län"          = "#FDD32F"
  )) +
  
  guides(color = guide_legend(title = NULL))

# Gör interaktivt
ggplotly(p2, tooltip = "text") %>%
    layout(
    annotations = list(
      list(
        text = "Källa: Arbetsförmedlingen och bearbetningar av Region Kronoberg.",
        x = 1, y = -0.2,  # Höger och nedanför x-axeln
        xref = "paper", yref = "paper",
        xanchor = "right", yanchor = "top", # Fäster i hörnet
        showarrow = FALSE,
        font = list(size = 11, color = "black")
      )
    ),
    margin = list(b = 100) # Lägg till utrymme under grafen
  )
```

# Företagande

## Konkurser

```{r konkurser_texter, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Läs in excelark
konkursdata <-read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\konkurser.xlsx")

# Förbered data
konkursdata <- konkursdata %>%
  mutate(
    Datum = as.Date(Datum),
    År = year(Datum), # Skapar en ny kolumn År - endast årtal från varje datum
    Månad = month(Datum, label = TRUE, abbr = FALSE) # Ny kolumn månad - mars istället för 3
  ) 

# Filtrera för Kronobergs län
konkurs_kronoberg <- konkursdata %>% filter(Region == "Kronobergs län")

# Hämta senaste datum i data för Kronoberg
max_datum <- max(konkurs_kronoberg$Datum)

# Hämta data för senaste månad
senaste_konk <- konkurs_kronoberg %>%
  filter(Datum == max_datum) %>%
  slice(1)

# Hämta data för föregående månad
föreg_månad_datum <- max_datum %m-% months(1)
föreg_månad_konk <- konkurs_kronoberg %>%
  filter(Datum == föreg_månad_datum) %>%
  slice(1)

# Summera antal konkurser per år
antal_per_år <- konkurs_kronoberg %>%
  group_by(År) %>%
  summarise(antal_konk = sum(`Antal konkurser`)) %>%
  filter(År %in% c(2022, 2023, 2024))

antal_2022_konk <- antal_per_år$antal_konk[antal_per_år$År == 2022]
antal_2023_konk <- antal_per_år$antal_konk[antal_per_år$År == 2023]
antal_2024_konk <- antal_per_år$antal_konk[antal_per_år$År == 2024]

# Skapa variabler för senaste månads värden
antal_senaste_konk <- senaste_konk$`Antal konkurser`
senaste_månad_konk <- as.character(senaste_konk$Månad)  # exempelvis "mars"
senaste_år_konk <- senaste_konk$År

# Jämförelse senaste månad med föregående månad
if (nrow(föreg_månad_konk) == 0) {
  trend_text <- "Det finns ingen data för föregående månad för att göra jämförelse."
} else {
  antal_föreg_månad <- föreg_månad_konk$`Antal konkurser`
  diff <- antal_senaste_konk - antal_föreg_månad
  
  trend_text <- ifelse(
    diff > 0,
    glue("Det är en ökning med {diff} konkurser jämfört med föregående månad."),
    ifelse(diff < 0,
           glue("Det är en minskning med {abs(diff)} konkurser jämfört med föregående månad."),
           "Antalet konkurser är oförändrat jämfört med föregående månad.")
  )
}

# Skapa texten med glue
text_konk <- glue(
  "Antalet konkurser i Kronobergs län uppgick till **{antal_senaste_konk}** stycken under {tolower(senaste_månad_konk)} {senaste_år_konk}. ",
  "{trend_text} ",
  "Totalt gick {antal_2024_konk} företag i konkurs år 2024, vilket kan jämföras med {antal_2023_konk} konkurser år 2023 samt ",
  "{antal_2022_konk} konkurser år 2022. Antalet konkurser år 2024 översteg därmed både 2022 och 2023."
)

# Bestäm senaste månad och år
senaste_år <- year(max_datum)
senaste_månad_nr <- month(max_datum)
senaste_månad_text <- tolower(month(max_datum, label = TRUE, abbr = FALSE))

# Föregående månad (hantera över årsskifte)
föreg_månad_datum <- max_datum %m-% months(1)
föreg_år <- year(föreg_månad_datum)
föreg_månad_nr <- month(föreg_månad_datum)

# Aggregat per län för senaste månad
data_senaste <- konkursdata %>%
  filter(year(Datum) == senaste_år, month(Datum) == senaste_månad_nr) %>%
  group_by(Region) %>%
  summarise(antal_konk = sum(`Antal konkurser`, na.rm = TRUE), .groups = "drop")

# Aggregat per län för föregående månad
data_föreg <- konkursdata %>%
  filter(year(Datum) == föreg_år, month(Datum) == föreg_månad_nr) %>%
  group_by(Region) %>%
  summarise(antal_konk = sum(`Antal konkurser`, na.rm = TRUE), .groups = "drop")

# Sammanställ och jämför, exkl. Kronoberg
jämförelse <- data_senaste %>%
  left_join(data_föreg, by = "Region", suffix = c("_senaste", "_föreg")) %>%
  filter(Region != "Kronobergs län") %>%
  mutate(
    skillnad = antal_konk_senaste - antal_konk_föreg,
    trend = case_when(
      skillnad > 0 ~ "ökat",
      skillnad < 0 ~ "minskat",
      TRUE ~ "oförändrat"
    )
  )

# Funktion för att formatera listor med "och"
format_lan <- function(lan_vector) {
  n <- length(lan_vector)
  if (n == 0) return("")
  if (n == 1) return(lan_vector)
  if (n == 2) return(paste(lan_vector, collapse = " och "))
  paste0(paste(lan_vector[1:(n - 1)], collapse = ", "), " och ", lan_vector[n])
}

# Listor med län efter trend
lan_ökat <- jämförelse %>% filter(trend == "ökat") %>% pull(Region)
lan_minskat <- jämförelse %>% filter(trend == "minskat") %>% pull(Region)
lan_oförändrat <- jämförelse %>% filter(trend == "oförändrat") %>% pull(Region)

# Funktion: ta bort " län" och sätt ihop snyggt med "och" + lägg tillbaka "län" i slutet
format_lan_koncist <- function(lan_vector) {
  lan_clean <- gsub(" län$", "", lan_vector)
  n <- length(lan_clean)
  if (n == 0) return("")
  if (n == 1) return(paste0(lan_clean, " län"))
  if (n == 2) return(paste0(paste(lan_clean, collapse = " och "), " län"))
  paste0(paste(lan_clean[1:(n - 1)], collapse = ", "), " och ", lan_clean[n], " län")
}

# Datumformat
månad_år <- tolower(format(max_datum, '%B %Y'))

# Skapa textstycken
text_ökakonk <- if (length(lan_ökat) > 0) {
  paste0("har antalet konkurser under ", månad_år, " ökat i ", format_lan_koncist(lan_ökat), ". ")
} else ""

text_minskakonk <- if (length(lan_minskat) > 0) {
  paste0("Samtidigt minskade antalet konkurser i ", format_lan_koncist(lan_minskat), ". ")
} else ""

text_oförändrat <- if (length(lan_oförändrat) > 0) {
  paste0("I ", format_lan_koncist(lan_oförändrat), " var antalet oförändrat jämfört med föregående månad.")
} else ""

# Sätt ihop fullständig text
text_konk_grannlan <- glue(
  "Jämfört med föregående månad {text_ökakonk}{text_minskakonk}{text_oförändrat}"
)
cat(text_konk, "\n\n", text_konk_grannlan)
```

```{r konkurser_diagram, echo=FALSE, message=FALSE, warning=FALSE}
# Skapa tooltip för hela datamängden
konkursdata$tooltip_text <- paste0(
  format(konkursdata$Datum, "%Y-%m"),
  "<br>Antal konkurser: ",
  format(konkursdata$`Antal konkurser`, big.mark = " "),
  "<br>Region: ",
  konkursdata$Region
)

# Hitta första dagen i senaste månad
senaste_manad <- floor_date(max(konkursdata$Datum), unit = "month")

# Skapa vektor av alla motsvarande månader bakåt i tiden (exkl. senaste månad)
historiska_manader <- seq(from = senaste_manad %m-% years(1),
                          to = senaste_manad %m-% years(10),
                          by = "-1 year")

# Filtrera historiska rader
historiskadata <- konkursdata %>%
  filter(floor_date(Datum, unit = "month") %in% historiska_manader)

# Filtrera senaste månadens data
senastedata <- konkursdata %>%
  filter(format(Datum, "%Y-%m") == format(senaste_manad, "%Y-%m"))


# Skapa ggplot
p3 <- ggplot(konkursdata, aes(x = Datum, y = `Antal konkurser`, color = Region)) +
  
  # Linjer för tidsserien
  geom_line(aes(text = tooltip_text, group = Region), alpha = 0.7, linewidth = 0.7) +
  
  # Svart punkt för senaste månad
  geom_point(
    data = senastedata,
    aes(x = Datum, y = `Antal konkurser`, text = tooltip_text),
    color = "black", size = 1.5, inherit.aes = FALSE
  ) +
  
  # Svarta punkter för samma månad varje tidigare år
  geom_point(
    data = historiskadata,
    aes(x = Datum, y = `Antal konkurser`, text = tooltip_text),
    color = "black", size = 1.5, inherit.aes = FALSE
  ) +
  
  facet_wrap(~ Region, scales = "free_y") +
  
  labs(
    title = "Antal konkurser",
    subtitle = paste("Senaste månad:", format(senaste_manad, "%B %Y")),
    caption = "Källa: Tillväxtanalys.",
    x = "",
    y = "Varierande skalor!"
  ) +
  
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(size = 10)
  ) +
  
  # Dynamisk x-axel: startar från 2022-01-01 till senaste månad
  scale_x_date(
    breaks = seq(as.Date("2022-01-01"), senaste_manad, by = "6 months"),
    date_labels = "%b %Y",
    limits = c(as.Date("2022-01-01"), senaste_manad)
  ) +
  
  scale_color_manual(values = c(
    "Kronobergs län"     = "#4CAF50",
    "Blekinge län"       = "#1A237E",
    "Hallands län"       = "#4FC3F7",
    "Kalmar län"         = "#EF5350",
    "Jönköpings län"     = "#AD1457",
    "Skåne län"          = "#FDD32F"
  )) +
  
  guides(color = guide_legend(title = NULL))

# Gör interaktivt
ggplotly(p3, tooltip = "text") %>%
    layout(
    annotations = list(
      list(
        text = "Källa: Tillväxtanalys och bearbetningar av Region Kronoberg.",
        x = 1, y = -0.2,  # Höger och nedanför x-axeln
        xref = "paper", yref = "paper",
        xanchor = "right", yanchor = "top", # Fäster i hörnet
        showarrow = FALSE,
        font = list(size = 11, color = "black")
      )
    ),
    margin = list(b = 100) # Lägg till utrymme under grafen
  )
```

## Nystartade företag

```{r nyaföretag_texter, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

nyftgdata <-read_excel("G:\\Analys och uppföljning\\Rapporter\\Näringsliv\\Näringslivsindikatorrapporten\\nystartade_ftg.xlsx") %>%
  mutate(Datum = as.Date(Datum),
         År = year(Datum),
         Månad = month(Datum))

# Hämta senaste månad
senaste_datum_nyftg <- max(nyftgdata$Datum, na.rm = TRUE)
senaste_år_nyftg <- year(senaste_datum_nyftg)
senaste_månad_nyftg <- month(senaste_datum_nyftg, label = TRUE, abbr = FALSE)
senaste_månad_nr <- month(senaste_datum_nyftg)

# Antal för senaste månad
senaste_antal_nyftg <- nyftgdata %>%
  filter(Datum == senaste_datum_nyftg) %>%
  pull(`Nystartade företag`) %>%
  sum(na.rm = TRUE)

# Ackumulerat antal jan–senaste månad för aktuellt år
antal_aktuellt_år <- nyftgdata %>%
  filter(År == senaste_år, Månad <= senaste_månad_nr) %>%
  summarise(n = sum(`Nystartade företag`)) %>%
  pull(n)

# Motsvarande period föregående år
antal_föreg_år <- nyftgdata %>%
  filter(År == (senaste_år_nyftg - 1), Månad <= senaste_månad_nr) %>%
  summarise(n = sum(`Nystartade företag`)) %>%
  pull(n)

# Totalsumma per år
årsvisa_sum <- nyftgdata %>%
  group_by(År) %>%
  summarise(antal = sum(`Nystartade företag`, na.rm = TRUE)) %>%
  filter(År %in% c(senaste_år_nyftg - 2, senaste_år_nyftg - 1, senaste_år_nyftg - 3))

antal_senast_fulla_år <- årsvisa_sum %>% filter(År == (senaste_år_nyftg - 1)) %>% pull(antal)
antal_forr_år1 <- årsvisa_sum %>% filter(År == (senaste_år_nyftg - 2)) %>% pull(antal)
antal_forr_år2 <- årsvisa_sum %>% filter(År == (senaste_år_nyftg - 3)) %>% pull(antal)

text_nystart <- glue(
  "Under {tolower(senaste_månad_nyftg)} månad etablerades **{senaste_antal_nyftg} nya företag** i Kronobergs län. ",
  "Totalt har {antal_aktuellt_år} nya företag startats under perioden januari till och med {tolower(senaste_månad_nyftg)} {senaste_år_nyftg}, ",
  "vilket kan jämföras med {antal_föreg_år} företag under samma period {senaste_år_nyftg - 1}. ",
  "För helåret {senaste_år_nyftg - 1} startades totalt {antal_senast_fulla_år} nya företag, ",
  "jämfört med {antal_forr_år1} företag {senaste_år_nyftg - 2} och {antal_forr_år2} företag {senaste_år_nyftg - 3}. ",
  "Statistiken omfattar de fyra vanligaste bolagsformerna: aktiebolag, enskild näringsidkare, handelsbolag och kommanditbolag<sup>2</sup>."
)

cat(text_nystart)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
nyftgdata <- nyftgdata %>%
  mutate(
    År = lubridate::year(Datum),
    Månad = lubridate::month(Datum, label = TRUE, abbr = TRUE)
  )

nyftgdata_summerad <- nyftgdata %>%
  group_by(År, Månad) %>%
  summarise(`Nystartade företag` = sum(`Nystartade företag`, na.rm = TRUE), .groups = "drop")

# Skapa TooltipText (behåller År, men inte factor(År))
nyftgdata_summerad <- nyftgdata_summerad %>%
  mutate(
    Highlight = År == 2025,
    TooltipText = paste(
      "År:", År,
      "<br>Månad:", Månad,
      "<br>Nystartade företag:", `Nystartade företag`
    )
  )

årsfärger <- c(
  "2020" = "#757575",
  "2021" = "#8E24AA",
  "2022" = "#FBC02D",
  "2023" = "#1E88E5",
  "2024" = "#E64A19",
  "2025" = "#388E3C"  # Grön
)
# ggplot
p_nyftg <- ggplot() +
  geom_line(
    data = filter(nyftgdata_summerad, !Highlight),
    aes(x = Månad, y = `Nystartade företag`, group = År, color = factor(År), text = TooltipText),
    size = 1, alpha = 0.4
  ) +
  geom_point(
    data = filter(nyftgdata_summerad, !Highlight),
    aes(x = Månad, y = `Nystartade företag`, group = År, color = factor(År), text = TooltipText),
    alpha = 0.4
  ) +
  geom_line(
    data = filter(nyftgdata_summerad, Highlight),
    aes(x = Månad, y = `Nystartade företag`, group = År, color = factor(År), text = TooltipText), size = 1.5
  ) +
  geom_point(
    data = filter(nyftgdata_summerad, Highlight),
    aes(x = Månad, y = `Nystartade företag`, group = År, color = factor(År), text = TooltipText), size = 2
  ) +
  scale_color_manual(values = årsfärger) +
  labs(
    title = "Nystartade företag per månad i Kronobergs län",
    x = "Månad",
    y = "Antal nystartade företag",
    color = "År"
  ) +
  theme_minimal()

# Gör interaktivt med enbart anpassad text
ggplotly(p_nyftg, tooltip = "text") %>%
    layout(
    annotations = list(
      list(
        text = "Källa: Bolagsverket och bearbetningar av Region Kronoberg.",
        x = 1, y = -0.2,  # Höger och nedanför x-axeln
        xref = "paper", yref = "paper",
        xanchor = "right", yanchor = "top", # Fäster i hörnet
        showarrow = FALSE,
        font = list(size = 11, color = "black")
      )
    ),
    margin = list(b = 100) # Lägg till utrymme under grafen
  )
```

# Noter

1. Statistik om alla lediga jobb är ändrad från september 2024 och bakåt i tiden till januari 2004. Läs mer om varför på arbetsförmedlingens hemsida. Länk: [Rättad statistik om lediga jobb - Arbetsförmedlingen](https://arbetsformedlingen.se/om-oss/press/nyheter/nyhetsarkiv/2024-12-12-rattad-statistik-om-lediga-jobb)

2. Statistiken gällande enskilda näringsidkare omfattar bara de som finns i Bolagsverkets register. Många enskilda näringsidkare är endast registrerade hos Skatteverket.

# Om webbplatsen

**Tillgänglighetsredogörelse**

Region Kronoberg står bakom den här webbplatsen. Vi vill att så många som möjligt ska kunna använda webbplatsen. Det här dokumentet beskriver hur webbplatsen uppfyller lagen om tillgänglighet till digital offentlig service, eventuella kända tillgänglighetsproblem och hur du kan rapportera brister till oss så att vi kan åtgärda dem.

**Hur tillgänglig är webbplatsen?** Webbplatsen är förenlig med lagen om tillgänglighet till digital offentlig service. 

**Vad kan du göra om du inte kan använda delar av webbplatsen?** Om du behöver innehåll från webbplatsen som inte är tillgängligt för dig, men som är undantaget från lagens tillämpningsområde enligt beskrivning nedan, kan du kontakta oss. Svarstiden är normalt tre arbetsdagar.

Du kan kontakta oss på följande sätt:<br>
- Skicka e-post till region@kronoberg.se<br>
- Ring 0470 - 58 80 00

**Rapportera brister i webbplatsens tillgänglighet.** Vi strävar hela tiden efter att förbättra webbplatsens tillgänglighet. Om du upptäcker problem som inte är beskrivna på den här sidan, eller om du anser att vi inte uppfyller lagens krav, kontakta oss så att vi får veta att problemet finns.

**Tillsyn.** Myndigheten för digital förvaltning har ansvaret för tillsyn för lagen om tillgänglighet till digital offentlig service. Om du inte är nöjd med hur vi hanterar ditt påpekande om bristande webbtillgänglighet eller din begäran om tillgängliggörande av innehåll kan du anmäla till [Myndigheten för digital förvaltning (DIGG)](https://www.digg.se/tdosanmalan).

**Teknisk information om webbplatsens tillgänglighet.** Den här webbplatsen är förenlig med nivå AA i standarden Web Content Accessibility Guidelines version 2.1. 

*Innehåll som inte omfattas av lagen.* Användning utan synförmåga eller användning med nedsatt syn.

**Hur vi testat webbplatsen.** Region Kronoberg har uppskattat tillgängligheten utan granskning. Senaste bedömningen gjordes den 25 juli 2025. Webbplatsen publicerades den 25 juli 2025. Redogörelsen uppdaterades senast den 25 juli 2025.